<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KYC Verification with Image Analysis</title>
    <style>
        :root {
            --primary: #4f46e5;
            --primary-hover: #4338ca;
            --secondary: #f3f4f6;
            --text: #1f2937;
            --error: #ef4444;
            --success: #10b981;
            --border: #e5e7eb;
            --warning: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f9fafb;
            color: var(--text);
            line-height: 1.5;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background-color: var(--primary);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .form-container {
            padding: 24px;
        }

        .form-section {
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 24px;
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .form-section h2 {
            font-size: 18px;
            margin-bottom: 16px;
            color: var(--primary);
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        input[type="text"],
        input[type="tel"],
        input[type="email"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        input[type="text"]:focus,
        input[type="tel"]:focus,
        input[type="email"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }

        .document-type {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .document-option {
            flex: 1;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 16px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .document-option:hover {
            border-color: var(--primary);
        }

        .document-option.selected {
            border-color: var(--primary);
            background-color: rgba(79, 70, 229, 0.05);
        }

        .document-option img {
            width: 60px;
            height: 60px;
            margin-bottom: 8px;
            object-fit: contain;
        }

        .document-option h3 {
            font-size: 16px;
            margin-bottom: 4px;
        }

        .document-option p {
            font-size: 14px;
            color: #6b7280;
        }

        .file-upload {
            border: 2px dashed var(--border);
            border-radius: 4px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .file-upload:hover {
            border-color: var(--primary);
        }

        .file-upload.dragover {
            border-color: var(--primary);
            background-color: rgba(79, 70, 229, 0.05);
        }

        .file-upload p {
            margin-bottom: 8px;
            color: #6b7280;
        }

        .file-upload input {
            display: none;
        }

        .upload-icon {
            font-size: 32px;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .preview-container {
            display: none;
            margin-top: 16px;
        }

        .preview-container img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        .error-message {
            color: var(--error);
            font-size: 14px;
            margin-top: 4px;
            display: none;
        }

        .button {
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
        }

        .button:hover {
            background-color: var(--primary-hover);
        }

        .button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        .verification-result {
            display: none;
            padding: 16px;
            border-radius: 4px;
            margin-top: 24px;
            text-align: center;
        }

        .verification-success {
            background-color: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            color: var(--success);
        }

        .verification-error {
            background-color: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--error);
            color: var(--error);
        }

        .verification-warning {
            background-color: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
        }

        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        @media (max-width: 640px) {
            .form-row {
                flex-direction: column;
                gap: 16px;
            }

            .document-type {
                flex-direction: column;
            }
        }

        .steps {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 16px;
        }

        .step {
            flex: 1;
            text-align: center;
            padding: 8px;
            position: relative;
        }

        .step-number {
            width: 32px;
            height: 32px;
            background-color: var(--secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 8px;
            font-weight: bold;
            color: #6b7280;
        }

        .step.active .step-number {
            background-color: var(--primary);
            color: white;
        }

        .step.completed .step-number {
            background-color: var(--success);
            color: white;
        }

        .step-title {
            font-size: 14px;
            font-weight: 500;
        }

        .step::after {
            content: '';
            position: absolute;
            top: 16px;
            right: -50%;
            width: 100%;
            height: 2px;
            background-color: var(--secondary);
            z-index: 0;
        }

        .step:last-child::after {
            display: none;
        }

        .step.active::after {
            background-color: var(--primary);
        }

        .step.completed::after {
            background-color: var(--success);
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .step-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 24px;
        }

        .step-buttons button {
            width: auto;
        }

        .back-button {
            background-color: var(--secondary);
            color: var(--text);
        }

        .back-button:hover {
            background-color: #e5e7eb;
        }

        .extracted-data {
            background-color: #f9fafb;
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 16px;
            margin-top: 16px;
        }

        .extracted-data h3 {
            margin-bottom: 8px;
            color: var(--primary);
        }

        .match-indicator {
            display: inline-block;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .match-indicator.match {
            background-color: var(--success);
        }

        .match-indicator.mismatch {
            background-color: var(--error);
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .data-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .data-label {
            font-weight: 500;
        }

        .data-value {
            color: #6b7280;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #canvas-container {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>KYC Verification</h1>
            <p>Verify your identity with Aadhar or PAN card</p>
        </div>

        <div class="form-container">
            <div class="steps">
                <div class="step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-title">Document Selection</div>
                </div>
                <div class="step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-title">Personal Details</div>
                </div>
                <div class="step" data-step="3">
                    <div class="step-number">3</div>
                    <div class="step-title">Document Upload</div>
                </div>
                <div class="step" data-step="4">
                    <div class="step-number">4</div>
                    <div class="step-title">Verification</div>
                </div>
            </div>

            <form id="kyc-form">
                <div class="step-content active" data-step="1">
                    <div class="form-section">
                        <h2>Select Document Type</h2>
                        <div class="document-type">
                            <div class="document-option" data-type="aadhar">
                                <img src="C:\Users\nikhi\Desktop\model for lending\static\images\aadhar.png" alt="Aadhar Card">

                                <h3>Aadhar Card</h3>
                                <p>12-digit unique identification number</p>
                            </div>
                            <div class="document-option" data-type="pan">
                                <img src="C:\Users\nikhi\Desktop\model for lending\static\images\pan.png" alt="Aadhar Card">
                                <h3>PAN Card</h3>
                                <p>Permanent Account Number for tax purposes</p>
                            </div>
                        </div>
                        <div class="form-group" id="aadhar-input" style="display: none;">
                            <label for="aadhar-number">Aadhar Number</label>
                            <input type="text" id="aadhar-number" placeholder="XXXX XXXX XXXX" maxlength="14">
                            <div class="error-message" id="aadhar-error"></div>
                        </div>
                        <div class="form-group" id="pan-input" style="display: none;">
                            <label for="pan-number">PAN Number</label>
                            <input type="text" id="pan-number" placeholder="ABCDE1234F" maxlength="10">
                            <div class="error-message" id="pan-error"></div>
                        </div>
                    </div>
                    <div class="step-buttons">
                        <div></div>
                        <button type="button" class="button next-step" disabled>Next</button>
                    </div>
                </div>

                <div class="step-content" data-step="2">
                    <div class="form-section">
                        <h2>Personal Details</h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="first-name">First Name</label>
                                <input type="text" id="first-name" required>
                                <div class="error-message" id="first-name-error"></div>
                            </div>
                            <div class="form-group">
                                <label for="last-name">Last Name</label>
                                <input type="text" id="last-name" required>
                                <div class="error-message" id="last-name-error"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dob">Date of Birth</label>
                                <input type="date" id="dob" required>
                                <div class="error-message" id="dob-error"></div>
                            </div>
                            <div class="form-group">
                                <label for="gender">Gender</label>
                                <select id="gender" required>
                                    <option value="">Select Gender</option>
                                    <option value="male">Male</option>
                                    <option value="female">Female</option>
                                    <option value="other">Other</option>
                                </select>
                                <div class="error-message" id="gender-error"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="mobile">Mobile Number</label>
                            <input type="tel" id="mobile" placeholder="+91 XXXXX XXXXX" required>
                            <div class="error-message" id="mobile-error"></div>
                        </div>
                        <div class="form-group">
                            <label for="email">Email Address</label>
                            <input type="email" id="email" required>
                            <div class="error-message" id="email-error"></div>
                        </div>
                    </div>
                    <div class="step-buttons">
                        <button type="button" class="button back-button prev-step">Back</button>
                        <button type="button" class="button next-step">Next</button>
                    </div>
                </div>

                <div class="step-content" data-step="3">
                    <div class="form-section">
                        <h2>Document Upload</h2>
                        <p>Please upload a clear photo of your <span id="document-type-text">document</span></p>
                        <div class="file-upload" id="file-upload">
                            <div class="upload-icon">📄</div>
                            <p>Drag and drop your document here or click to browse</p>
                            <p><small>Supported formats: JPG, PNG (Max size: 5MB)</small></p>
                            <input type="file" id="document-file" accept=".jpg,.jpeg,.png">
                        </div>
                        <div class="error-message" id="file-error"></div>
                        <div class="preview-container" id="preview-container">
                            <h3>Document Preview</h3>
                            <img id="document-preview" src="/placeholder.svg" alt="Document Preview">
                        </div>
                        <div id="canvas-container">
                            <canvas id="analysis-canvas" style="display: none;"></canvas>
                        </div>
                    </div>
                    <div class="step-buttons">
                        <button type="button" class="button back-button prev-step">Back</button>
                        <button type="button" class="button next-step" id="upload-next" disabled>Next</button>
                    </div>
                </div>

                <div class="step-content" data-step="4">
                    <div class="form-section">
                        <h2>Verification</h2>
                        <p>We've analyzed your document and extracted the following information:</p>
                        
                        <div class="extracted-data" id="extracted-data">
                            <!-- This will be populated by JavaScript -->
                        </div>
                        
                        <div class="verification-result" id="verification-result"></div>
                    </div>
                    <div class="step-buttons">
                        <button type="button" class="button back-button prev-step">Back</button>
                        <button type="button" class="button" id="verify-button">Verify</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <!-- Firebase Realtime Database -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBTl1mnk3kTFysFtmzpXvbLjmcVMlzEkRU",
            authDomain: "lending-app-559fa.firebaseapp.com",
            databaseURL: "https://lending-app-559fa-default-rtdb.firebaseio.com",
            projectId: "lending-app-559fa",
            storageBucket: "lending-app-559fa.appspot.com",
            messagingSenderId: "13752692266",
            appId: "1:13752692266:web:47efd0589f20850fa75d53",
            measurementId: "G-MQSLBQDNS1"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        
        // Get Firebase Realtime Database reference
        const database = firebase.database();

        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const documentOptions = document.querySelectorAll('.document-option');
            const aadharInput = document.getElementById('aadhar-input');
            const panInput = document.getElementById('pan-input');
            const nextButtons = document.querySelectorAll('.next-step');
            const prevButtons = document.querySelectorAll('.prev-step');
            const verifyButton = document.getElementById('verify-button');
            const fileUpload = document.getElementById('file-upload');
            const documentFile = document.getElementById('document-file');
            const previewContainer = document.getElementById('preview-container');
            const documentPreview = document.getElementById('document-preview');
            const uploadNext = document.getElementById('upload-next');
            const documentTypeText = document.getElementById('document-type-text');
            const verificationResult = document.getElementById('verification-result');
            const extractedDataContainer = document.getElementById('extracted-data');
            const loadingOverlay = document.getElementById('loading-overlay');
            const analysisCanvas = document.getElementById('analysis-canvas');

            // Variables
            let selectedDocType = null;
            let currentStep = 1;
            let uploadedFile = null;
            let extractedData = null;
            let sessionId = generateSessionId(); // Generate a unique session ID for this verification
            let isValidDocument = false;

            // Document Type Selection
            documentOptions.forEach(option => {
                option.addEventListener('click', function() {
                    documentOptions.forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedDocType = this.dataset.type;
                    
                    // Show the appropriate input field
                    if (selectedDocType === 'aadhar') {
                        aadharInput.style.display = 'block';
                        panInput.style.display = 'none';
                        documentTypeText.textContent = 'Aadhar Card';
                    } else {
                        aadharInput.style.display = 'none';
                        panInput.style.display = 'block';
                        documentTypeText.textContent = 'PAN Card';
                    }
                    
                    // Enable next button if a document type is selected
                    nextButtons[0].disabled = false;
                });
            });

            // Step Navigation
            function goToStep(step) {
                // Hide all step contents
                document.querySelectorAll('.step-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // Show the current step content
                document.querySelector(`.step-content[data-step="${step}"]`).classList.add('active');
                
                // Update step indicators
                document.querySelectorAll('.step').forEach(stepEl => {
                    const stepNum = parseInt(stepEl.dataset.step);
                    stepEl.classList.remove('active', 'completed');
                    
                    if (stepNum === step) {
                        stepEl.classList.add('active');
                    } else if (stepNum < step) {
                        stepEl.classList.add('completed');
                    }
                });

                currentStep = step;
            }

            // Next button click handler
            nextButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Validate current step
                    if (validateStep(currentStep)) {
                        if (currentStep === 3) {
                            // Before going to step 4, analyze the document
                            analyzeDocument();
                        } else {
                            goToStep(currentStep + 1);
                        }
                    }
                });
            });

            // Previous button click handler
            prevButtons.forEach(button => {
                button.addEventListener('click', function() {
                    goToStep(currentStep - 1);
                });
            });

            // File Upload
            fileUpload.addEventListener('click', function() {
                documentFile.click();
            });

            fileUpload.addEventListener('dragover', function(e) {
                e.preventDefault();
                this.classList.add('dragover');
            });

            fileUpload.addEventListener('dragleave', function() {
                this.classList.remove('dragover');
            });

            fileUpload.addEventListener('drop', function(e) {
                e.preventDefault();
                this.classList.remove('dragover');
                
                if (e.dataTransfer.files.length) {
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });

            documentFile.addEventListener('change', function() {
                if (this.files.length) {
                    handleFileUpload(this.files[0]);
                }
            });

            function handleFileUpload(file) {
                // Validate file type and size
                const validTypes = ['image/jpeg', 'image/png'];
                const maxSize = 5 * 1024 * 1024; // 5MB
                
                if (!validTypes.includes(file.type)) {
                    showError('file-error', 'Invalid file type. Please upload JPG or PNG.');
                    return;
                }
                
                if (file.size > maxSize) {
                    showError('file-error', 'File size exceeds 5MB limit.');
                    return;
                }
                
                // Clear any previous errors
                hideError('file-error');
                
                // Store the file for later upload
                uploadedFile = file;
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    documentPreview.src = e.target.result;
                    previewContainer.style.display = 'block';
                    
                    // Check if the image looks like an ID card
                    checkIfValidDocument(e.target.result);
                };
                reader.readAsDataURL(file);
            }

            // Check if the uploaded image looks like an ID card
            function checkIfValidDocument(imageDataUrl) {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = function() {
                    // Set canvas dimensions to match image
                    analysisCanvas.width = img.width;
                    analysisCanvas.height = img.height;
                    
                    // Draw image on canvas
                    const ctx = analysisCanvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, img.width, img.height);
                    
                    // Get image data for analysis
                    const imageData = ctx.getImageData(0, 0, img.width, img.height);
                    const data = imageData.data;
                    
                    // Simple image analysis to detect if it might be an ID card
                    // 1. Check aspect ratio (ID cards are typically rectangular)
                    const aspectRatio = img.width / img.height;
                    const isRectangular = aspectRatio > 1.3 && aspectRatio < 1.8;
                    
                    // 2. Check for uniform background (ID cards often have uniform backgrounds)
                    let backgroundVariation = 0;
                    const sampleSize = 100; // Sample points to check
                    const samplePoints = [];
                    
                    // Sample points from the image
                    for (let i = 0; i < sampleSize; i++) {
                        const x = Math.floor(Math.random() * img.width);
                        const y = Math.floor(Math.random() * img.height);
                        const index = (y * img.width + x) * 4;
                        samplePoints.push({
                            r: data[index],
                            g: data[index + 1],
                            b: data[index + 2]
                        });
                    }
                    
                    // Calculate variation in background color
                    let totalVariation = 0;
                    for (let i = 0; i < samplePoints.length - 1; i++) {
                        for (let j = i + 1; j < samplePoints.length; j++) {
                            const variation = Math.sqrt(
                                Math.pow(samplePoints[i].r - samplePoints[j].r, 2) +
                                Math.pow(samplePoints[i].g - samplePoints[j].g, 2) +
                                Math.pow(samplePoints[i].b - samplePoints[j].b, 2)
                            );
                            totalVariation += variation;
                        }
                    }
                    backgroundVariation = totalVariation / (sampleSize * (sampleSize - 1) / 2);
                    
                    // 3. Check for text-like patterns (ID cards have text)
                    // This is a simplified approach - we're looking for high contrast areas
                    let edgeCount = 0;
                    const edgeThreshold = 50;
                    
                    for (let y = 1; y < img.height - 1; y++) {
                        for (let x = 1; x < img.width - 1; x++) {
                            const idx = (y * img.width + x) * 4;
                            const idxLeft = (y * img.width + (x - 1)) * 4;
                            const idxRight = (y * img.width + (x + 1)) * 4;
                            
                            const rDiff = Math.abs(data[idx] - data[idxLeft]) + Math.abs(data[idx] - data[idxRight]);
                            const gDiff = Math.abs(data[idx + 1] - data[idxLeft + 1]) + Math.abs(data[idx + 1] - data[idxRight + 1]);
                            const bDiff = Math.abs(data[idx + 2] - data[idxLeft + 2]) + Math.abs(data[idx + 2] - data[idxRight + 2]);
                            
                            const diff = rDiff + gDiff + bDiff;
                            if (diff > edgeThreshold) {
                                edgeCount++;
                            }
                        }
                    }
                    
                    const edgeRatio = edgeCount / (img.width * img.height);
                    
                    // Combine factors to determine if it's likely an ID card
                    isValidDocument = isRectangular && backgroundVariation < 100 && edgeRatio > 0.05 && edgeRatio < 0.3;
                    
                    // Enable/disable next button based on validation
                    if (isValidDocument) {
                        uploadNext.disabled = false;
                        hideError('file-error');
                    } else {
                        uploadNext.disabled = true;
                        showError('file-error', 'The uploaded image does not appear to be a valid ID document. Please upload a clear photo of your ' + (selectedDocType === 'aadhar' ? 'Aadhar Card' : 'PAN Card'));
                    }
                };
                img.src = imageDataUrl;
            }

            // Analyze Document
            function analyzeDocument() {
                if (!uploadedFile) {
                    showError('file-error', 'Please upload your document');
                    return;
                }
                
                if (!isValidDocument) {
                    showError('file-error', 'The uploaded image does not appear to be a valid ID document');
                    return;
                }
                
                showLoading();
                
                try {
                    // Convert the file to base64 for storing in the database
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const base64String = e.target.result;
                        
                        // Extract information from the document using OCR simulation
                        extractDocumentInfo(base64String).then(function(data) {
                            extractedData = data;
                            
                            // Display the extracted data
                            displayExtractedData();
                            
                            // Save the verification data to Realtime Database
                            saveVerificationData(base64String);
                            
                            // Go to the next step
                            goToStep(currentStep + 1);
                            hideLoading();
                        });
                    };
                    reader.readAsDataURL(uploadedFile);
                } catch (error) {
                    console.error("Error in analyzeDocument:", error);
                    hideLoading();
                    showError('file-error', 'Error analyzing document: ' + error.message);
                }
            }

            // Extract information from the document (simulated OCR)
            function extractDocumentInfo(imageDataUrl) {
                return new Promise((resolve) => {
                    // In a real application, this would use an OCR service
                    // For this demo, we'll extract data based on the document type and user input
                    
                    const firstName = document.getElementById('first-name').value;
                    const lastName = document.getElementById('last-name').value;
                    const dob = document.getElementById('dob').value;
                    const docNumber = selectedDocType === 'aadhar' ? 
                        document.getElementById('aadhar-number').value.replace(/\s/g, '') : 
                        document.getElementById('pan-number').value;
                    
                    // For Aadhar, we'll simulate extracting the actual number from the image
                    // In a real app, this would be done with OCR
                    let extractedDocNumber;
                    
                    if (selectedDocType === 'aadhar') {
                        // Simulate extracting Aadhar number from image
                        // In 70% of cases, we'll extract the correct number
                        // In 30% of cases, we'll have a digit error
                        if (Math.random() < 0.7) {
                            extractedDocNumber = docNumber;
                        } else {
                            // Change one digit
                            const digits = docNumber.split('');
                            const posToChange = Math.floor(Math.random() * 12);
                            digits[posToChange] = (parseInt(digits[posToChange]) + 1) % 10;
                            extractedDocNumber = digits.join('');
                        }
                    } else {
                        // For PAN, similar logic
                        if (Math.random() < 0.7) {
                            extractedDocNumber = docNumber;
                        } else {
                            // Change one character
                            const chars = docNumber.split('');
                            const posToChange = Math.floor(Math.random() * 10);
                            if (posToChange >= 5 && posToChange <= 8) {
                                // If it's a digit part
                                chars[posToChange] = ((parseInt(chars[posToChange]) + 1) % 10).toString();
                            } else {
                                // If it's a letter part
                                const charCode = chars[posToChange].charCodeAt(0);
                                chars[posToChange] = String.fromCharCode(((charCode - 65 + 1) % 26) + 65);
                            }
                            extractedDocNumber = chars.join('');
                        }
                    }
                    
                    // For name and DOB, we'll use a similar approach
                    let extractedFirstName, extractedLastName, extractedDob;
                    
                    // 80% chance of correct extraction
                    if (Math.random() < 0.8) {
                        extractedFirstName = firstName;
                    } else {
                        // Slight variation in name
                        extractedFirstName = firstName.charAt(0) + firstName.substring(1).toLowerCase();
                    }
                    
                    if (Math.random() < 0.8) {
                        extractedLastName = lastName;
                    } else {
                        // Slight variation in name
                        extractedLastName = lastName + (lastName.endsWith('a') ? '' : 'a');
                    }
                    
                    if (Math.random() < 0.8) {
                        extractedDob = dob;
                    } else {
                        // Slight variation in DOB (1 day off)
                        const dobDate = new Date(dob);
                        dobDate.setDate(dobDate.getDate() + 1);
                        extractedDob = dobDate.toISOString().split('T')[0];
                    }
                    
                    // Simulate processing delay
                    setTimeout(() => {
                        resolve({
                            firstName: extractedFirstName,
                            lastName: extractedLastName,
                            dob: extractedDob,
                            documentNumber: extractedDocNumber,
                            documentType: selectedDocType
                        });
                    }, 2000);
                });
            }

            function displayExtractedData() {
                if (!extractedData) return;
                
                const userFirstName = document.getElementById('first-name').value;
                const userLastName = document.getElementById('last-name').value;
                const userDob = document.getElementById('dob').value;
                const userDocNumber = selectedDocType === 'aadhar' ? 
                    document.getElementById('aadhar-number').value.replace(/\s/g, '') : 
                    document.getElementById('pan-number').value;
                
                // Check if data matches
                const firstNameMatch = extractedData.firstName === userFirstName;
                const lastNameMatch = extractedData.lastName === userLastName;
                const dobMatch = extractedData.dob === userDob;
                const docNumberMatch = extractedData.documentNumber === userDocNumber;
                
                // Calculate overall match percentage
                const matchCount = [firstNameMatch, lastNameMatch, dobMatch, docNumberMatch].filter(Boolean).length;
                const matchPercentage = Math.round((matchCount / 4) * 100);
                
                // Create HTML for extracted data
                let html = `
                    <h3>Document Analysis Results (${matchPercentage}% match)</h3>
                    <div class="data-row">
                        <div class="data-label">
                            <span class="match-indicator ${firstNameMatch ? 'match' : 'mismatch'}"></span>
                            First Name
                        </div>
                        <div class="data-value">${extractedData.firstName}</div>
                    </div>
                    <div class="data-row">
                        <div class="data-label">
                            <span class="match-indicator ${lastNameMatch ? 'match' : 'mismatch'}"></span>
                            Last Name
                        </div>
                        <div class="data-value">${extractedData.lastName}</div>
                    </div>
                    <div class="data-row">
                        <div class="data-label">
                            <span class="match-indicator ${dobMatch ? 'match' : 'mismatch'}"></span>
                            Date of Birth
                        </div>
                        <div class="data-value">${extractedData.dob}</div>
                    </div>
                    <div class="data-row">
                        <div class="data-label">
                            <span class="match-indicator ${docNumberMatch ? 'match' : 'mismatch'}"></span>
                            ${selectedDocType === 'aadhar' ? 'Aadhar' : 'PAN'} Number
                        </div>
                        <div class="data-value">${extractedData.documentNumber}</div>
                    </div>
                `;
                
                extractedDataContainer.innerHTML = html;
                
                // Update verification button based on match percentage
                if (matchPercentage === 100) {
                    verifyButton.textContent = 'Confirm Verification';
                    verifyButton.disabled = false;
                    
                    // Show success message
                    verificationResult.textContent = 'All information matches! You can proceed with verification.';
                    verificationResult.className = 'verification-result verification-success';
                    verificationResult.style.display = 'block';
                } else if (matchPercentage >= 75) {
                    verifyButton.textContent = 'Proceed with Verification';
                    verifyButton.disabled = false;
                    
                    // Show warning
                    verificationResult.textContent = 'Most information matches, but there are some minor discrepancies. You can still proceed with verification.';
                    verificationResult.className = 'verification-result verification-warning';
                    verificationResult.style.display = 'block';
                } else {
                    verifyButton.textContent = 'Information Mismatch';
                    verifyButton.disabled = true;
                    
                    // Show error
                    verificationResult.textContent = 'The information extracted from your document does not match the details you provided. Please check and try again.';
                    verificationResult.className = 'verification-result verification-error';
                    verificationResult.style.display = 'block';
                }
            }

            function saveVerificationData(documentBase64) {
                // Save verification data to Realtime Database
                const verificationRef = database.ref('verifications/' + sessionId);
                verificationRef.set({
                    sessionId: sessionId,
                    documentType: selectedDocType,
                    documentNumber: selectedDocType === 'aadhar' ? 
                        document.getElementById('aadhar-number').value : 
                        document.getElementById('pan-number').value,
                    firstName: document.getElementById('first-name').value,
                    lastName: document.getElementById('last-name').value,
                    dob: document.getElementById('dob').value,
                    gender: document.getElementById('gender').value,
                    mobile: document.getElementById('mobile').value,
                    email: document.getElementById('email').value,
                    documentImage: documentBase64,
                    extractedData: extractedData,
                    timestamp: new Date().toISOString(),
                    status: 'pending'
                }).catch(function(error) {
                    console.error('Error saving verification data:', error);
                });
            }

            // Verify button click handler
            verifyButton.addEventListener('click', function() {
                showLoading();
                
                // Calculate match percentage
                const userFirstName = document.getElementById('first-name').value;
                const userLastName = document.getElementById('last-name').value;
                const userDob = document.getElementById('dob').value;
                const userDocNumber = selectedDocType === 'aadhar' ? 
                    document.getElementById('aadhar-number').value.replace(/\s/g, '') : 
                    document.getElementById('pan-number').value;
                
                const firstNameMatch = extractedData.firstName === userFirstName;
                const lastNameMatch = extractedData.lastName === userLastName;
                const dobMatch = extractedData.dob === userDob;
                const docNumberMatch = extractedData.documentNumber === userDocNumber;
                
                const matchCount = [firstNameMatch, lastNameMatch, dobMatch, docNumberMatch].filter(Boolean).length;
                const matchPercentage = Math.round((matchCount / 4) * 100);
                
                // Update the verification status in Realtime Database
                const verificationRef = database.ref('verifications/' + sessionId);
                
                if (matchPercentage >= 75) {
                    // If match percentage is good enough, verify
                    verificationRef.update({
                        status: 'verified',
                        verifiedAt: new Date().toISOString()
                    }).then(function() {
                        // Show success message
                        verificationResult.textContent = 'Verification successful! Your identity has been verified.';
                        verificationResult.className = 'verification-result verification-success';
                        verificationResult.style.display = 'block';
                        
                        verifyButton.textContent = 'Verified';
                        verifyButton.disabled = true;
                        
                        // Mark the last step as completed
                        document.querySelector(`.step[data-step="4"]`).classList.remove('active');
                        document.querySelector(`.step[data-step="4"]`).classList.add('completed');
                        
                        // Redirect to main page after 2 seconds
                        setTimeout(function() {
                            // In a real app, you would redirect to your main page
                            // For this demo, we'll just show an alert
                            alert('Verification successful! Redirecting to main page...');
                            
                            // Create a simple main page and redirect to it
                            const mainPage = document.createElement('div');
                            mainPage.innerHTML = `
                                <div style="text-align: center; padding: 50px;">
                                    <h1 style="color: #4f46e5;">Welcome to the Main Page</h1>
                                    <p>Your identity has been successfully verified.</p>
                                    <button onclick="window.location.reload()" style="background-color: #4f46e5; color: white; border: none; padding: 10px 20px; border-radius: 4px; margin-top: 20px; cursor: pointer;">Start Over</button>
                                </div>
                            `;
                            
                            // Replace the entire body content
                            document.body.innerHTML = '';
                            document.body.appendChild(mainPage);
                        }, 2000);
                    }).catch(function(error) {
                        console.error('Error updating verification status:', error);
                        hideLoading();
                    });
                } else {
                    // If match percentage is too low, reject
                    verificationRef.update({
                        status: 'rejected',
                        rejectedAt: new Date().toISOString(),
                        rejectionReason: 'Information mismatch'
                    }).then(function() {
                        // Show error message
                        verificationResult.textContent = 'Verification failed. The information from your document does not match the details you provided.';
                        verificationResult.className = 'verification-result verification-error';
                        verificationResult.style.display = 'block';
                        
                        verifyButton.textContent = 'Rejected';
                        verifyButton.disabled = true;
                        
                        hideLoading();
                    }).catch(function(error) {
                        console.error('Error updating verification status:', error);
                        hideLoading();
                    });
                }
            });

            // Validation
            function validateStep(step) {
                let isValid = true;
                
                switch(step) {
                    case 1:
                        // Validate document number
                        if (selectedDocType === 'aadhar') {
                            const aadharNumber = document.getElementById('aadhar-number').value.replace(/\s/g, '');
                            if (!/^\d{12}$/.test(aadharNumber)) {
                                showError('aadhar-error', 'Please enter a valid 12-digit Aadhar number');
                                isValid = false;
                            } else {
                                hideError('aadhar-error');
                            }
                        } else if (selectedDocType === 'pan') {
                            const panNumber = document.getElementById('pan-number').value;
                            if (!/^[A-Z]{5}[0-9]{4}[A-Z]{1}$/.test(panNumber)) {
                                showError('pan-error', 'Please enter a valid PAN number (e.g., ABCDE1234F)');
                                isValid = false;
                            } else {
                                hideError('pan-error');
                            }
                        } else {
                            isValid = false;
                        }
                        break;
                    
                    case 2:
                        // Validate personal details
                        const fields = [
                            { id: 'first-name', pattern: /^[A-Za-z]{2,}$/, message: 'Please enter a valid first name' },
                            { id: 'last-name', pattern: /^[A-Za-z]{2,}$/, message: 'Please enter a valid last name' },
                            { id: 'dob', required: true, message: 'Please select your date of birth' },
                            { id: 'gender', required: true, message: 'Please select your gender' },
                            { id: 'mobile', pattern: /^[0-9]{10}$/, message: 'Please enter a valid 10-digit mobile number' },
                            { id: 'email', pattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/, message: 'Please enter a valid email address' }
                        ];
                        
                        fields.forEach(field => {
                            const element = document.getElementById(field.id);
                            let fieldValid = true;
                            
                            if (field.required && !element.value) {
                                fieldValid = false;
                            } else if (field.pattern && !field.pattern.test(element.value)) {
                                fieldValid = false;
                            }
                            
                            if (!fieldValid) {
                                showError(`${field.id}-error`, field.message);
                                isValid = false;
                            } else {
                                hideError(`${field.id}-error`);
                            }
                        });
                        break;
                    
                    case 3:
                        // File upload validation
                        if (!uploadedFile) {
                            showError('file-error', 'Please upload your document');
                            isValid = false;
                        } else if (!isValidDocument) {
                            showError('file-error', 'The uploaded image does not appear to be a valid ID document');
                            isValid = false;
                        }
                        break;
                }
                
                return isValid;
            }

            // Format input fields
            document.getElementById('aadhar-number').addEventListener('input', function(e) {
                let value = e.target.value.replace(/\D/g, '');
                if (value.length > 0) {
                    value = value.match(new RegExp('.{1,4}', 'g')).join(' ');
                }
                e.target.value = value;
            });

            document.getElementById('pan-number').addEventListener('input', function(e) {
                e.target.value = e.target.value.toUpperCase();
            });

            document.getElementById('mobile').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '');
            });

            // Helper functions
            function showError(id, message) {
                const errorElement = document.getElementById(id);
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }

            function hideError(id) {
                const errorElement = document.getElementById(id);
                errorElement.style.display = 'none';
            }

            function showLoading() {
                loadingOverlay.style.display = 'flex';
            }

            function hideLoading() {
                loadingOverlay.style.display = 'none';
            }

            function generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2, 15);
            }
        });
    </script>
</body>
</html>